<!doctype html>
<html lang="fr" data-bs-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebShot • Capture d’écran</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --brand:#e26e2c; }
    .brand { color: var(--brand); }
    .btn-brand { background: var(--brand); color:#fff; }
    .btn-brand:hover { filter: brightness(.95); color:#fff; }
    .card-opts label{ cursor:pointer; }
    .skeleton{ background: linear-gradient(90deg,#f2f2f2 25%,#e9ecef 37%,#f2f2f2 63%); background-size:400% 100%; animation:shimmer 1.4s infinite; }
    @keyframes shimmer{ 0%{background-position:100% 0} 100%{background-position:-100% 0} }
    .fixed-preview { max-height: 70vh; overflow:auto; }
    .kbd{border:1px solid #ccc;border-bottom-width:2px;border-radius:.3rem;padding:.1rem .35rem;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-sm bg-body-tertiary border-bottom">
    <div class="container">
      <span class="navbar-brand fw-semibold"><span class="brand">WebShot</span></span>
      <div class="ms-auto">
        <button class="btn btn-sm btn-outline-secondary" id="toggle-theme" type="button" title="Thème">Thème</button>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <div class="row g-4">
      <div class="col-lg-5">
        <form id="form" class="card shadow-sm">
          <div class="card-body">
            <div class="mb-3">
              <label for="url" class="form-label">URL à capturer</label>
              <div class="input-group">
                <span class="input-group-text">https://</span>
                <input type="text" inputmode="url" class="form-control" id="url" placeholder="example.com" required>
                <button class="btn btn-outline-secondary" type="button" id="paste">Coller</button>
              </div>
              <div class="form-text">Ex: <code>example.com</code> ou <code>https://example.com/page</code></div>
            </div>

            <div class="row g-3 card-opts">
              <div class="col-6">
                <label class="form-label">Appareil</label>
                <div class="btn-group w-100" role="group" aria-label="device">
                  <input type="radio" class="btn-check" name="device" id="dev-desktop" value="desktop" checked>
                  <label class="btn btn-outline-primary" for="dev-desktop">Desktop</label>
                  <input type="radio" class="btn-check" name="device" id="dev-mobile" value="mobile">
                  <label class="btn btn-outline-primary" for="dev-mobile">Mobile</label>
                </div>
              </div>
              <div class="col-6">
                <label class="form-label">Zone</label>
                <div class="btn-group w-100" role="group" aria-label="mode">
                  <input type="radio" class="btn-check" name="mode" id="mode-full" value="full" checked>
                  <label class="btn btn-outline-primary" for="mode-full">Page entière</label>
                  <input type="radio" class="btn-check" name="mode" id="mode-viewport" value="viewport">
                  <label class="btn btn-outline-primary" for="mode-viewport">Viewport</label>
                </div>
              </div>
            </div>

            <div class="row g-3 mt-1">
              <div class="col-6">
                <label class="form-label" for="delay">Attente réseau (ms)</label>
                <input type="number" class="form-control" id="delay" min="0" step="250" value="0">
                <div class="form-text">Optionnel. Pour les SPA lentes.</div>
              </div>
              <div class="col-6">
                <label class="form-label" for="filename">Nom de fichier</label>
                <input type="text" class="form-control" id="filename" placeholder="auto">
                <div class="form-text">Laisser vide pour automatique.</div>
              </div>
            </div>

            <div class="d-flex align-items-center gap-2 mt-4">
              <button class="btn btn-brand" type="submit" id="go">
                <span class="spinner-border spinner-border-sm me-2 d-none" id="spin" role="status" aria-hidden="true"></span>
                Générer
              </button>
              <button class="btn btn-outline-secondary" type="reset" id="reset">Réinitialiser</button>
              <div class="ms-auto">
                <button class="btn btn-outline-primary" type="button" id="download" disabled>Télécharger</button>
              </div>
            </div>

            <div class="alert alert-danger mt-3 d-none" id="error" role="alert"></div>
            <div class="alert alert-info mt-3 d-none" id="hint" role="alert">
              Astuce: <span class="kbd">Ctrl</span> + <span class="kbd">L</span> puis coller l’URL.
            </div>
          </div>
        </form>
      </div>

      <div class="col-lg-7">
        <div class="card shadow-sm">
          <div class="card-header d-flex align-items-center justify-content-between">
            <span class="fw-semibold">Aperçu</span>
            <div>
              <a class="btn btn-sm btn-outline-secondary me-2" id="openNew" target="_blank" rel="noopener" hidden>Ouvrir l’image</a>
              <a class="btn btn-sm btn-outline-secondary" id="copyLink" hidden>Copier le lien</a>
            </div>
          </div>
          <div class="card-body fixed-preview" id="preview">
            <div class="ratio ratio-16x9 skeleton rounded-3" id="placeholder"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Thème
    document.getElementById('toggle-theme').onclick = () => {
      const html = document.documentElement;
      html.setAttribute('data-bs-theme', html.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark');
    };

    const form = document.getElementById('form');
    const urlInput = document.getElementById('url');
    const delayInput = document.getElementById('delay');
    const filenameInput = document.getElementById('filename');
    const spin = document.getElementById('spin');
    const errorBox = document.getElementById('error');
    const hint = document.getElementById('hint');
    const preview = document.getElementById('preview');
    const placeholder = document.getElementById('placeholder');
    const btnDownload = document.getElementById('download');
    const btnOpen = document.getElementById('openNew');
    const btnCopy = document.getElementById('copyLink');

    // Coller
    document.getElementById('paste').onclick = async () => {
      try { urlInput.value = await navigator.clipboard.readText(); } catch {}
    };

    // Reset
    document.getElementById('reset').onclick = () => {
      form.reset();
      btnDownload.disabled = true; btnOpen.hidden = true; btnCopy.hidden = true;
      errorBox.classList.add('d-none'); hint.classList.add('d-none');
      preview.innerHTML = ''; preview.appendChild(placeholder); placeholder.classList.remove('d-none');
    };

    // Normalisation URL
    function normalizeURL(v){
      if (!v) return v;
      if (!/^https?:\/\//i.test(v)) v = 'https://' + v;
      return v;
    }

    // Téléchargement
    function triggerDownload(url, name){
      const a = document.createElement('a');
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // Nom auto
    function autoName(u, device, mode){
      try {
        const { hostname, pathname } = new URL(u);
        const cleanPath = pathname.replace(/\/+/g,'_').replace(/^_?|_?$/g,'') || 'home';
        const ts = new Date().toISOString().replaceAll(':','').replaceAll('-','').split('.')[0];
        return `${hostname}_${cleanPath}_${device}_${mode}_${ts}.png`;
      } catch { return `screenshot_${device}_${mode}.png`; }
    }

    // Soumission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const device = form.querySelector('input[name="device"]:checked').value;
      const mode = form.querySelector('input[name="mode"]:checked').value;
      const delay = parseInt(delayInput.value || '0', 10) || 0;
      let url = normalizeURL(urlInput.value.trim());

      errorBox.classList.add('d-none');
      hint.classList.add('d-none');
      btnDownload.disabled = true; btnOpen.hidden = true; btnCopy.hidden = true;
      spin.classList.remove('d-none');
      placeholder.classList.remove('d-none');
      preview.scrollTop = 0;

      // Ajout d’un petit paramètre côté API si vous implémentez le "delay"
      const payload = { url, device, mode };
      if (delay > 0) payload.delay = delay;

      try {
        const r = await fetch('/api/screenshot', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!r.ok) {
          const t = await r.text();
          throw new Error(t || `HTTP ${r.status}`);
        }
        const blob = await r.blob();
        const objURL = URL.createObjectURL(blob);

        preview.innerHTML = '';
        const img = document.createElement('img');
        img.src = objURL;
        img.alt = 'Capture';
        img.className = 'img-fluid rounded border';
        preview.appendChild(img);

        const name = (filenameInput.value || '').trim() || autoName(url, device, mode);
        btnDownload.disabled = false;
        btnDownload.onclick = () => triggerDownload(objURL, name);

        btnOpen.hidden = false; btnOpen.href = objURL;
        btnCopy.hidden = false; btnCopy.onclick = async () => {
          try { await navigator.clipboard.writeText(objURL); btnCopy.textContent = 'Lien copié'; setTimeout(()=>btnCopy.textContent='Copier le lien',1200);} catch {}
        };
      } catch (err) {
        errorBox.textContent = err?.message?.replace(/^"?|"?$/g,'') || 'Erreur inconnue';
        errorBox.classList.remove('d-none');
        hint.classList.remove('d-none');
      } finally {
        spin.classList.add('d-none');
        placeholder.classList.add('d-none');
      }
    });

    function renderPlaceholder(){
      const ph = document.createElement('div');
      ph.className = 'ratio ratio-16x9 skeleton rounded-3';
      return ph;
    }

    form.addEventListener('reset', (e) => {
      // attendre que le reset natif ait vidé les champs
      setTimeout(() => {
        // champs
        urlInput.value = '';
        delayInput.value = '0';
        filenameInput.value = '';

        // UI
        btnDownload.disabled = true;
        btnOpen.hidden = true;
        btnCopy.hidden = true;
        errorBox.classList.add('d-none');
        hint.classList.add('d-none');

        // Aperçu
        preview.innerHTML = '';
        preview.appendChild(renderPlaceholder());
        preview.scrollTop = 0;
      }, 0);
    });
  </script>
</body>
</html>
